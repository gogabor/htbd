# Root is fleet
# scope is solar_system

htbd_debug = {
	always = no
}

htbd_not_recent_planet = {
	NAND = {
		has_planet_flag = htbd_recent
		# if all planets are with recent flag, ignore that flag
		solar_system = {
			any_planet = {
				NOT = { has_planet_flag = htbd_recent }
			}
		}
	}
}

htbd_preferable_planet = {
	OR = {
		has_planet_flag = egg_incubated
		AND = {
			is_star = yes
			NOR = {
				is_planet_class = pc_black_hole
				is_planet_class = pc_neutron_star
				is_planet_class = pc_pulsar
			}
		}
		is_planet_class = pc_asteroid
		is_planet_class = pc_gas_giant
		is_planet_class = pc_molten
	}
}

# fleet
htbd_idontcare = {
	has_fleet_flag = htbd_curious
	has_fleet_flag = htbd_stupid
	has_fleet_flag = htbd_mad
}

htbd_unpleasant_planet = {
	OR = {
		AND = {
			is_star = yes
			OR = {
				is_planet_class = pc_black_hole
				is_planet_class = pc_neutron_star
				is_planet_class = pc_pulsar
			}
		}
		is_planet_class = pc_frozen
		is_capital = yes
		is_colony = yes
	}
}

htbd_can_interrupt_fleet = {
	NOR = {
		has_fleet_flag = htbd_travel
		has_fleet_flag = htbd_healing
	}
}

# max names in name_list (84) but limit maximum by 50
htbd_max = {
	num_fleets > 50
}

htbd_has_fear_edict = {
	OR = {
		has_edict = htbd_dragon_fear
		has_country_flag = htbd_fear_edict
	}
}

htbd_has_friend_edict = {
	OR = {
		has_edict = htbd_dragon_friend
		has_country_flag = htbd_friend_edict
	}
}

htbd_is_dragon_fear = {
	exists = space_owner
	space_owner = {
		# some countries have permanent fear effect, e.g. fallen, marauders, etc.
		OR = {
			htbd_has_fear_edict = yes
			is_country_type = guardian_fortress
			AND = {
				OR = {
					is_country_type = fallen_empire
					is_country_type = awakened_fallen_empire
					is_country_type = dormant_marauders
					is_country_type = awakened_marauders
				}
				NOT = { has_country_flag = htbd_dragon_scent }
			}
		}
	}
}

# scope = system
htbd_has_fear_station = {
	htbd_is_dragon_fear = yes
	OR = {
		AND = {
			exists = starbase
			starbase = { has_starbase_size > starbase_starport }
		}
		any_planet = {
			OR = {
				is_planet_class = pc_habitat
				has_building = building_fortress
				has_building = building_capital_2
				has_building = building_capital_3
			}
		}
		has_star_flag = enigmatic_system
	}
}

# scope = system
htbd_has_fear_aura = {
	OR = {
		AND = {
			htbd_is_dragon_fear = yes
			exists = starbase
			starbase = { has_starbase_size = starbase_starport }
		}
		any_neighbor_system = {
			ignore_hyperlanes = no
			htbd_has_fear_station = yes
		}
	}
}

# dragons don't like such systems and will leave them asap
htbd_bad_system = {
	OR = {
		is_star_class = sc_black_hole
		htbd_has_fear_station = yes
	}
}

# dragons avoid staying in such systems
htbd_avoid_system = {
	OR = {
		is_star_class = sc_pulsar
		is_star_class = sc_neutron_star
		has_star_flag = htbd_death_place
		htbd_has_fear_aura = yes
	}
}

htbd_good_system = {
	NOR = {
		htbd_bad_system = yes
		htbd_avoid_system = yes
		is_bottleneck_system = yes
		AND = {
			exists = space_owner
			space_owner = { NOT = { has_country_flag = htbd_dragon_scent } }
			any_planet = {
				OR = {
					is_capital = yes
					is_colony = yes
				}
			}
		}
	}
}

htbd_is_good_for_egg = {
	htbd_good_system = yes
	# too hot stars
	NOR = {
		is_star_class = sc_a
		is_star_class = sc_b
	}
	# need molten for egg
	any_planet = {
		is_planet_class = pc_molten
	}
}

# system scope
htbd_may_travel_to = {
	NOT = {
		is_same_value = root.solar_system
	}
	OR = {
		NOT = { has_star_flag = htbd_recent_star_@root }
		root = { has_fleet_flag = htbd_ignore_recent }
		root = { has_fleet_flag = htbd_stuck }
	}
	OR = {
		NOT = { htbd_bad_system = yes }
		root = { has_fleet_flag = htbd_mad }
		root = { has_fleet_flag = htbd_stuck_stuck }
	}
	OR = {
		NOT = { htbd_avoid_system = yes }
		root = { has_fleet_flag = htbd_curiousity }
		root = { has_fleet_flag = htbd_stuck }
	}
}

# fleet
htbd_need_hull = {
	has_hp_percentage < 0.7
}

# fleet
htbd_need_armor = {
	owner = {
		any_owned_ship = {
			fleet = { is_same_value = root }
			is_damaged = yes
			#has_hp_percentage < 1.0
		}
	}
}

# This = system
htbd_has_starbase_ftl_inhibitor = {
	exists = starbase
	starbase = { has_starbase_size >= starbase_starport }
	exists = owner
	owner = {
		has_technology = "tech_ftl_inhibitor"
	}
}

# This = system
htbd_has_planetary_ftl_inhibitor = {
	any_planet = {
		OR = {
			has_building = building_stronghold
			has_building = building_fortress
		}
	}
	exists = owner
	owner = {
		has_technology = "tech_ftl_inhibitor"
	}
}

htbd_has_ftl_inhibitor = {
	OR = {
		htbd_has_planetary_ftl_inhibitor = yes
		htbd_has_starbase_ftl_inhibitor = yes
	}
}

# scope = system
# prev = country
htbd_is_waypoint = {
	OR = {
		is_point_of_interest = {
			id = htbd_way_poi.1
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.2
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.3
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.4
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.5
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.6
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.7
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.8
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.9
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.10
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.11
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.12
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.13
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.14
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.15
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.16
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.17
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.18
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.19
			event_chain = htbd_way_chain
			owner = prev
		}
		is_point_of_interest = {
			id = htbd_way_poi.20
			event_chain = htbd_way_chain
			owner = prev
		}
	}
}

htbd_friend_civics = {
	OR = {
		has_valid_civic = civic_syncretic_evolution
		has_valid_civic = civic_machine_servitor

		has_ethic = ethic_fanatic_xenophile
	}
}

htbd_foe_civics = {
	OR = {
		has_valid_civic = civic_fanatic_purifiers
		has_valid_civic = civic_hive_devouring_swarm
		has_valid_civic = civic_machine_terminator

		has_ethic = ethic_fanatic_xenophobe
	}
}

htbd_friend_way_is_done = {
	OR = {
		has_country_flag = htbd_way_of_dragon_done
		AND = {
			has_country_flag = htbd_liked_systems_done
			NOT = {
				check_variable = { which = htbd_avoid_systems value < @htbd_min_opposite_systems }
			}
		}
	}
}

htbd_foe_way_is_done = {
	OR = {
		has_country_flag = htbd_way_of_dragon_done
		AND = {
			has_country_flag = htbd_avoid_systems_done
			NOT = {
				check_variable = { which = htbd_liked_systems value < @htbd_min_opposite_systems }
			}
		}
	}
}
